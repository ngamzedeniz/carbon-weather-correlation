<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Carbon Intensity & Weather Explorer</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
body { background: #f0f2f5; font-family: 'Inter', sans-serif; }
.container { margin-top: 40px; max-width: 1000px; }
.card { box-shadow: 0 6px 20px rgba(0,0,0,0.08); border-radius: 15px; padding: 25px; background: #fff; margin-bottom: 25px; transition: transform 0.2s, box-shadow 0.2s;}
.card:hover { transform: translateY(-3px); box-shadow: 0 12px 25px rgba(0,0,0,0.15); }
#chart { height: 500px; margin-top: 15px; }
.share-buttons { margin-top: 20px; text-align: center; }
.btn-gradient { background: linear-gradient(90deg,#00b894,#55efc4); color: #fff; border: none; transition: 0.3s; }
.btn-gradient:hover { opacity: 0.85; }
footer { margin-top: 40px; text-align: center; color: #6c757d; font-size: 0.9rem; }
@media (max-width:768px){ #chart{height:400px;} }
</style>
</head>
<body>

<div class="container">

  <div class="card">
    <h2 class="mb-3 text-center">ðŸŒ¿ Carbon Intensity & Weather Explorer</h2>
    <p class="text-muted text-center">Explore how carbon intensity relates to weather by country and date range.</p>
    <div class="row g-3 align-items-end">
      <div class="col-md-3 col-6">
        <label for="country" class="form-label">Country</label>
        <select id="country" class="form-select">
          <option value="DE">Germany</option>
          <option value="FR">France</option>
          <option value="ES">Spain</option>
          <option value="IT">Italy</option>
        </select>
      </div>
      <div class="col-md-2 col-6">
        <label for="start" class="form-label">Start Date</label>
        <input type="date" id="start" class="form-control">
      </div>
      <div class="col-md-2 col-6">
        <label for="end" class="form-label">End Date</label>
        <input type="date" id="end" class="form-control">
      </div>
      <div class="col-md-2 col-6">
        <label for="granularity" class="form-label">Granularity</label>
        <select id="granularity" class="form-select">
          <option value="hourly" selected>Hourly</option>
          <option value="daily">Daily</option>
        </select>
      </div>
      <div class="col-md-3 col-12 d-grid">
        <button id="loadData" class="btn btn-gradient btn-lg"><i class="fas fa-play me-2"></i>Load Data</button>
      </div>
    </div>
    <div id="status" class="text-center text-muted mt-3"></div>
  </div>

  <div id="chart" class="card"></div>

  <div class="share-buttons">
    <a id="shareLinkedIn" href="#" target="_blank" class="btn btn-primary me-2"><i class="fab fa-linkedin me-1"></i>LinkedIn</a>
    <a id="shareX" href="#" target="_blank" class="btn btn-info"><i class="fab fa-x-twitter me-1"></i>X</a>
  </div>

  <footer>Developed by Gamze Deniz</footer>
</div>

<script>
let cache = {};

function getDefaultDates() {
  const end = new Date();
  const start = new Date();
  start.setDate(end.getDate() - 6); // last 7 days
  const fmt = d => d.toISOString().slice(0,10);
  return [fmt(start), fmt(end)];
}

async function loadData(defaultLoad=false) {
  const countryEl = document.getElementById("country");
  const startEl = document.getElementById("start");
  const endEl = document.getElementById("end");
  const granularityEl = document.getElementById("granularity");
  const status = document.getElementById("status");

  const country = countryEl.value;
  let start = startEl.value;
  let end = endEl.value;
  const granularity = granularityEl.value;
  const chartDiv = document.getElementById("chart");

  if (!start || !end) [start, end] = getDefaultDates();

  const cacheKey = `${country}_${start}_${end}_${granularity}`;
  if (cache[cacheKey]) {
    drawChart(cache[cacheKey]);
    status.innerText = `Data loaded from cache for ${country} (${start} â†’ ${end})`;
    return;
  }

  status.innerHTML = `<div class="spinner-border spinner-border-sm me-2" role="status"></div>Loading data...`;

  const coords = { "DE":[51.1657,10.4515], "FR":[46.2276,2.2137], "ES":[40.4637,-3.7492], "IT":[41.8719,12.5674] };
  const [lat, lon] = coords[country];

  // Fetch weather data
  const wData = await (await fetch(`https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${start}&end_date=${end}&hourly=temperature_2m,wind_speed_10m&timezone=auto`)).json();
  const temps = wData.hourly?.temperature_2m || [];
  const winds = wData.hourly?.wind_speed_10m || [];
  const times = wData.hourly?.time || [];

  // Fetch carbon intensity
  const cData = await (await fetch("https://data.open-power-system-data.org/carbon-intensity/2024-10-01/carbon_intensity_day-ahead.json")).json();
  let carbon = cData.data.filter(d => {
    const date = d.time.slice(0,10);
    return date>=start && date<=end;
  }).map(d=>d.intensity_actual || d.intensity_forecast);

  let chartData = { temps, winds, carbon, times };

  if (granularity === "daily") {
    const daily = {};
    chartData.times.forEach((t,i)=>{
      const day = t.slice(0,10);
      if (!daily[day]) daily[day] = { temps: [], winds: [], carbon: [] };
      daily[day].temps.push(chartData.temps[i]);
      daily[day].winds.push(chartData.winds[i]);
      daily[day].carbon.push(chartData.carbon[i]);
    });
    const days = Object.keys(daily);
    chartData = {
      temps: days.map(d=>daily[d].temps.reduce((a,b)=>a+b,0)/daily[d].temps.length),
      winds: days.map(d=>daily[d].winds.reduce((a,b)=>a+b,0)/daily[d].winds.length),
      carbon: days.map(d=>daily[d].carbon.reduce((a,b)=>a+b,0)/daily[d].carbon.length)
    };
  }

  cache[cacheKey] = chartData;
  drawChart(chartData);

  status.innerText = `Data loaded for ${country} (${start} â†’ ${end})`;

  const pageUrl = encodeURIComponent(window.location.href);
  const shareText = encodeURIComponent(`Check out this Carbon Intensity & Weather Explorer for ${country}`);
  document.getElementById("shareLinkedIn").href = `https://www.linkedin.com/sharing/share-offsite/?url=${pageUrl}`;
  document.getElementById("shareX").href = `https://twitter.com/intent/tweet?url=${pageUrl}&text=${shareText}`;
}

function drawChart({temps,winds,carbon}) {
  const mean = arr => arr.reduce((a,b)=>a+b,0)/arr.length;
  const corr = (x,y)=>{
    const mx=mean(x), my=mean(y);
    const num=x.map((xi,i)=>(xi-mx)*(y[i]-my)).reduce((a,b)=>a+b,0);
    const den=Math.sqrt(x.map(xi=>(xi-mx)**2).reduce((a,b)=>a+b,0)*y.map(yi=>(yi-my)**2).reduce((a,b)=>a+b,0));
    return (num/den).toFixed(2);
  };
  const corrWind = corr(winds,carbon);
  const corrTemp = corr(temps,carbon);

  const trace1 = { x:winds, y:carbon, mode:"markers", name:"Wind vs Carbon", marker:{color:"green"}, hovertemplate: 'Wind: %{x} m/s<br>Carbon: %{y} gCOâ‚‚/kWh<extra></extra>' };
  const trace2 = { x:temps, y:carbon, mode:"markers", name:"Temp vs Carbon", marker:{color:"orange"}, hovertemplate: 'Temp: %{x} Â°C<br>Carbon: %{y} gCOâ‚‚/kWh<extra></extra>' };

  const layout = {
    title: `Correlation â€” Wind: ${corrWind}, Temp: ${corrTemp}`,
    xaxis:{title:"Variable Value"}, yaxis:{title:"Carbon Intensity (gCOâ‚‚/kWh)"},
    hovermode:"closest",
    paper_bgcolor:"#f0f2f5", plot_bgcolor:"#fff",
    margin:{t:60,r:30,l:60,b:50}
  };

  Plotly.react(document.getElementById("chart"), [trace1, trace2], layout);
}

document.getElementById("loadData").addEventListener("click", ()=>loadData(false));
window.addEventListener("load", ()=>loadData(true));
</script>
</body>
</html>
